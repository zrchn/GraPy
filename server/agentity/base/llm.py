from openai import AsyncOpenAI
import asyncio
import traceback
from basic.configer import configer
from loguru import logger
from utils.disp import disp as display

class OpenAILLM:
    base_url: str
    api_key: str
    default_model: str
    default_sys_prompt: str = '你是一名AI助手，请你按用户的要求提供回答。'
    default_temperature: int = 0.3
    aclient: AsyncOpenAI

    def __init__(self, base_url=None, api_key=None, default_model='', default_temperature=None, timeout=100):
        self.base_url = base_url or configer.llm.base_url
        self.api_key = api_key or configer.llm.api_key
        self.default_model = default_model or getattr(configer.llm, 'model', None)
        if default_temperature is not None:
            self.default_temperature = default_temperature
        if self.default_temperature is None:
            self.default_temperature = 0.3
        self.aclient = AsyncOpenAI(base_url=self.base_url, api_key=self.api_key, timeout=timeout)

    async def astream(self, messages, model=None, disp=True, temperature=None):
        mymodel = model or self.default_model
        my_temp = temperature
        if my_temp is None:
            my_temp = self.default_temperature
        logger.info(f'正在调用模型{mymodel}, temperature={my_temp}')
        response = await self.aclient.chat.completions.create(model=mymodel, messages=messages, stream=True, temperature=my_temp)
        async for chunk in response:
            chunk_message = chunk.choices[0].delta.content or None if chunk.choices else None
            think_message = getattr(chunk.choices[0].delta, 'reasoning_content', None) if chunk.choices else None
            if disp:
                if chunk_message:
                    print(chunk_message, end='')
                if think_message:
                    display(think_message, color='cyan', end='')
            finish_reason = chunk.choices[0].finish_reason if chunk.choices and hasattr(chunk.choices[0], 'finish_reason') else None
            if chunk_message:
                yield chunk_message
        print()

    async def aanswer(self, messages, model=None, disp=True, temperature=None):
        if disp:
            rsp = ''
            astreamer = self.astream(messages, model=model, disp=disp, temperature=temperature)
            async for chunk in astreamer:
                rsp = rsp + chunk
            return rsp
        else:
            response = await self.aclient.chat.completions.create(model=model or self.default_model, messages=messages, stream=False)
            return response.choices[0].message.content

    async def _aask(self, prompt, sys_prompt=None, model=None, temperature=None):
        messages = [{'role': 'system', 'content': sys_prompt or self.default_sys_prompt}, {'role': 'user', 'content': prompt}]
        rsp = await self.aanswer(messages, model=model, temperature=temperature)
        return rsp

    async def aask(self, prompt, sys_prompt=None, model=None, temperature=None):
        rsp = await self._aask(prompt, sys_prompt=sys_prompt, model=model, temperature=temperature)
        return rsp
if __name__ == '__main__':
    llm = OpenAILLM(base_url='https://dashscope.aliyuncs.com/compatible-mode/v1', api_key='sk-16650834a7ec4f7793b41485fd860cf2', default_model='qwen2.5-72b-instruct')
    messages = [{'role': 'system', 'content': 'You are a helpful assistant.'}, {'role': 'user', 'content': '\n    \n\n    # Task Instruction: follow this instruction and output as required in a string\n    优化排序生产任务利用大模型能力，根据changeover表中的清洗步数，重新排序生产任务，并给出每条生产任务重新安排的日期，以最小化清洗步数。建议把Material Type相同的任务排在一起。resource: Resource:LF07 \n\n    # Context:\n    - Earlier Result: Information previously extracted from relevant queries. might be useful if the instruction needs\n    {\'5\': {\'task_id\': \'5\', \'title\': \'筛选一条生产线的生产任务表\', \'instruction\': \'对于每个Resource值，从zppc_with_material表中筛选并下载一条生产线的生产任务表。resource: Resource:LF07\', \'type\': \'functional\', \'input_parameters\': {\'sql\': "SELECT * FROM zppc_with_material WHERE Resource = \'LF07\'", \'download_full\': True, \'export_table_name\': \'zppc_filtered_LF07\'}, \'time_taken\': -1, \'token_taken\': -1, \'middle_results\': [], \'result\': [{\'category\': 0, \'category_translated\': \'text\', \'content\': [{\'Week\': 8, \'Resource\': \'LF07\', \'Order #\': 100600087, \'Material #\': 2004265, \'Earliest Operation Start Date\': \'2025-02-17\', \'R/3 start minus finish time\': 235, \'id\': 0, \'Material Type\': \'Concentrate – P1\'}, {\'Week\': 8, \'Resource\': \'LF07\', \'Order #\': 100601783, \'Material #\': 2004265, \'Earliest Operation Start Date\': \'2025-02-17\', \'R/3 start minus finish time\': 102, \'id\': 1, \'Material Type\': \'Concentrate – P1\'}, {\'Week\': 8, \'Resource\': \'LF07\', \'Order #\': 100601784, \'Material #\': 2004265, \'Earliest Operation Start Date\': \'2025-02-17\', \'R/3 start minus finish time\': 102, \'id\': 2, \'Material Type\': \'Concentrate – P1\'}, {\'Week\': 8, \'Resource\': \'LF07\', \'Order #\': 100600088, \'Material #\': 2004265, \'Earliest Operation Start Date\': \'2025-02-17\', \'R/3 start minus finish time\': 102, \'id\': 3, \'Material Type\': \'Concentrate – P1\'}, {\'Week\': 8, \'Resource\': \'LF07\', \'Order #\': 100600090, \'Material #\': 2004265, \'Earliest Operation Start Date\': \'2025-02-17\', \'R/3 start minus finish time\': 102, \'id\': 4, \'Material Type\': \'Concentrate – P1\'}, {\'Week\': 8, \'Resource\': \'LF07\', \'Order #\': 100600089, \'Material #\': 2004265, \'Earliest Operation Start Date\': \'2025-02-17\', \'R/3 start minus finish time\': 235, \'id\': 5, \'Material Type\': \'Concentrate – P1\'}, {\'Week\': 8, \'Resource\': \'LF07\', \'Order #\': 100600092, \'Material #\': 2004266, \'Earliest Operation Start Date\': \'2025-02-18\', \'R/3 start minus finish time\': 247, \'id\': 6, \'Material Type\': \'Concentrate – P2\'}, {\'Week\': 8, \'Resource\': \'LF07\', \'Order #\': 100600093, \'Material #\': 2004266, \'Earliest Operation Start Date\': \'2025-02-18\', \'R/3 start minus finish time\': 247, \'id\': 7, \'Material Type\': \'Concentrate – P2\'}, {\'Week\': 8, \'Resource\': \'LF07\', \'Order #\': 100603802, \'Material #\': 2004266, \'Earliest Operation Start Date\': \'2025-02-19\', \'R/3 start minus finish time\': 247, \'id\': 8, \'Material Type\': \'Concentrate – P2\'}, {\'Week\': 8, \'Resource\': \'LF07\', \'Order #\': 100603803, \'Material #\': 2004266, \'Earliest Operation Start Date\': \'2025-02-19\', \'R/3 start minus finish time\': 247, \'id\': 9, \'Material Type\': \'Concentrate – P2\'}, {\'Week\': 9, \'Resource\': \'LF07\', \'Order #\': 100606932, \'Material #\': 2004266, \'Earliest Operation Start Date\': \'2025-02-24\', \'R/3 start minus finish time\': 247, \'id\': 51, \'Material Type\': \'Concentrate – P2\'}, {\'Week\': 9, \'Resource\': \'LF07\', \'Order #\': 100606933, \'Material #\': 2004266, \'Earliest Operation Start Date\': \'2025-02-24\', \'R/3 start minus finish time\': 247, \'id\': 52, \'Material Type\': \'Concentrate – P2\'}, {\'Week\': 9, \'Resource\': \'LF07\', \'Order #\': 100606927, \'Material #\': 2004265, \'Earliest Operation Start Date\': \'2025-02-24\', \'R/3 start minus finish time\': 235, \'id\': 53, \'Material Type\': \'Concentrate – P1\'}, {\'Week\': 9, \'Resource\': \'LF07\', \'Order #\': 100606928, \'Material #\': 2004265, \'Earliest Operation Start Date\': \'2025-02-25\', \'R/3 start minus finish time\': 102, \'id\': 54, \'Material Type\': \'Concentrate – P1\'}, {\'Week\': 9, \'Resource\': \'LF07\', \'Order #\': 100606929, \'Material #\': 2004265, \'Earliest Operation Start Date\': \'2025-02-25\', \'R/3 start minus finish time\': 235, \'id\': 55, \'Material Type\': \'Concentrate – P1\'}, {\'Week\': 9, \'Resource\': \'LF07\', \'Order #\': 100606930, \'Material #\': 2004265, \'Earliest Operation Start Date\': \'2025-02-25\', \'R/3 start minus finish time\': 102, \'id\': 56, \'Material Type\': \'Concentrate – P1\'}]}], \'warning_info\': [], \'success\': True}, \'2\': {\'task_id\': \'2\', \'title\': \'查询changeover表\', \'instruction\': \'从changeover表中查询所有数据，以备后续使用。\', \'type\': \'functional\', \'input_parameters\': {\'sql\': \'SELECT * FROM changeover\', \'download_full\': True, \'export_table_name\': \'changeover_results\'}, \'time_taken\': -1, \'token_taken\': -1, \'middle_results\': [], \'result\': [{\'category\': 0, \'category_translated\': \'text\', \'content\': [{\'Material Type\': \'Concentrate – P1\', \'Concentrate – P1\': 0, \'Concentrate – P2\': 1, \'Pungent\': 3, \'Sensitive\': 3, \'Others\': 3, \'id\': 0}, {\'Material Type\': \'Concentrate – P2\', \'Concentrate – P1\': 3, \'Concentrate – P2\': 0, \'Pungent\': 3, \'Sensitive\': 3, \'Others\': 3, \'id\': 1}, {\'Material Type\': \'Pungent\', \'Concentrate – P1\': 5, \'Concentrate – P2\': 5, \'Pungent\': 5, \'Sensitive\': 5, \'Others\': 5, \'id\': 2}, {\'Material Type\': \'Sensitive\', \'Concentrate – P1\': 5, \'Concentrate – P2\': 5, \'Pungent\': 5, \'Sensitive\': 5, \'Others\': 5, \'id\': 3}, {\'Material Type\': \'Others\', \'Concentrate – P1\': 5, \'Concentrate – P2\': 5, \'Pungent\': 3, \'Sensitive\': 3, \'Others\': 3, \'id\': 4}]}], \'warning_info\': [], \'success\': True}}\n    - User Query: The initial query from the user, which may provide specific details to support the current task.\n    \n\n    # Step2:\n    1. follow the task instruction strictly and use info from the above context if needed. Earlier Result most likely contains info you need to use\n    2. put final answer in \'\'\'result    \'\'\'\n\n\n    # Expected output:do not output the thinking process!!!output the final result directly!!!\n    ```result\n\n            the_final_result\n\n    ```\n\n\n    '}]
    messages = [{'role': 'system', 'content': 'You are a helpful assistant.'}, {'role': 'user', 'content': '\n    \n\n    # Task Instruction: follow this instruction and output as required in a string\n    优化排序生产任务：根据changeover表中的清洗步数，重新排序生产任务，以最小化清洗步数，并以markdown表格形式展现结果，结果中不需包含Earliest Operation Start Date，而是要给出你推荐的生产日期。resource: LF09 \n\n    # Context:\n    - Earlier Result: Information previously extracted from relevant queries. might be useful if the instruction needs\n    {\'5\': {\'task_id\': \'5\', \'title\': \'筛选一条生产线的生产任务表\', \'instruction\': \'对于每个Resource值，从zppc_with_material表中筛选并下载一条生产线的生产任务表。resource: LF09\', \'type\': \'functional\', \'input_parameters\': {\'export_table_name\': \'zppc_with_material_LF09\', \'sql\': "SELECT * FROM zppc_with_material WHERE Resource = \'LF09\'", \'download_full\': True}, \'time_taken\': -1, \'token_taken\': -1, \'middle_results\': [], \'result\': [{\'category\': 0, \'category_translated\': \'text\', \'content\': [{\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100594637, \'Material #\': 3024408, \'Earliest Operation Start Date\': \'2025-02-17\', \'R/3 start minus finish time\': 160, \'id\': 12, \'Material Type\': \'Others\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100588884, \'Material #\': 3049201, \'Earliest Operation Start Date\': \'2025-02-17\', \'R/3 start minus finish time\': 80, \'id\': 13, \'Material Type\': \'Others\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100575080, \'Material #\': 3215590, \'Earliest Operation Start Date\': \'2025-02-17\', \'R/3 start minus finish time\': 167, \'id\': 14, \'Material Type\': \'Others\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100596739, \'Material #\': 2084010, \'Earliest Operation Start Date\': \'2025-02-18\', \'R/3 start minus finish time\': 0, \'id\': 15, \'Material Type\': \'Others\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100596738, \'Material #\': 2084010, \'Earliest Operation Start Date\': \'2025-02-18\', \'R/3 start minus finish time\': 217, \'id\': 16, \'Material Type\': \'Others\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100582516, \'Material #\': 3049201, \'Earliest Operation Start Date\': \'2025-02-19\', \'R/3 start minus finish time\': 75, \'id\': 17, \'Material Type\': \'Others\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100589008, \'Material #\': 1709914, \'Earliest Operation Start Date\': \'2025-02-19\', \'R/3 start minus finish time\': 149, \'id\': 18, \'Material Type\': \'Others\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100582511, \'Material #\': 3000500, \'Earliest Operation Start Date\': \'2025-02-19\', \'R/3 start minus finish time\': 97, \'id\': 19, \'Material Type\': \'Pungent\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100589178, \'Material #\': 1647295, \'Earliest Operation Start Date\': \'2025-02-19\', \'R/3 start minus finish time\': 73, \'id\': 20, \'Material Type\': \'Pungent\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100582512, \'Material #\': 3008539, \'Earliest Operation Start Date\': \'2025-02-19\', \'R/3 start minus finish time\': 78, \'id\': 21, \'Material Type\': \'Pungent\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100589009, \'Material #\': 1723784, \'Earliest Operation Start Date\': \'2025-02-19\', \'R/3 start minus finish time\': 85, \'id\': 22, \'Material Type\': \'Others\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100582507, \'Material #\': 2084804, \'Earliest Operation Start Date\': \'2025-02-19\', \'R/3 start minus finish time\': 79, \'id\': 23, \'Material Type\': \'Pungent\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100582534, \'Material #\': 3181769, \'Earliest Operation Start Date\': \'2025-02-21\', \'R/3 start minus finish time\': 79, \'id\': 24, \'Material Type\': \'Others\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100606955, \'Material #\': 3134621, \'Earliest Operation Start Date\': \'2025-02-21\', \'R/3 start minus finish time\': 78, \'id\': 25, \'Material Type\': \'Others\'}, {\'Week\': 8, \'Resource\': \'LF09\', \'Order #\': 100606954, \'Material #\': 3134621, \'Earliest Operation Start Date\': \'2025-02-21\', \'R/3 start minus finish time\': 71, \'id\': 26, \'Material Type\': \'Others\'}, {\'Week\': 9, \'Resource\': \'LF09\', \'Order #\': 100589013, \'Material #\': 1709916, \'Earliest Operation Start Date\': \'2025-02-24\', \'R/3 start minus finish time\': 190, \'id\': 61, \'Material Type\': \'Others\'}, {\'Week\': 9, \'Resource\': \'LF09\', \'Order #\': 100605801, \'Material #\': 1704686, \'Earliest Operation Start Date\': \'2025-02-24\', \'R/3 start minus finish time\': 125, \'id\': 62, \'Material Type\': \'Sensitive\'}, {\'Week\': 9, \'Resource\': \'LF09\', \'Order #\': 100575262, \'Material #\': 3215591, \'Earliest Operation Start Date\': \'2025-02-25\', \'R/3 start minus finish time\': 167, \'id\': 63, \'Material Type\': \'Others\'}, {\'Week\': 9, \'Resource\': \'LF09\', \'Order #\': 100605258, \'Material #\': 3059064, \'Earliest Operation Start Date\': \'2025-02-25\', \'R/3 start minus finish time\': 116, \'id\': 64, \'Material Type\': \'Others\'}, {\'Week\': 9, \'Resource\': \'LF09\', \'Order #\': 100582532, \'Material #\': 3179207, \'Earliest Operation Start Date\': \'2025-02-26\', \'R/3 start minus finish time\': 79, \'id\': 65, \'Material Type\': \'Others\'}, {\'Week\': 9, \'Resource\': \'LF09\', \'Order #\': 100582533, \'Material #\': 3179510, \'Earliest Operation Start Date\': \'2025-02-26\', \'R/3 start minus finish time\': 79, \'id\': 66, \'Material Type\': \'Others\'}, {\'Week\': 9, \'Resource\': \'LF09\', \'Order #\': 100606900, \'Material #\': 3132308, \'Earliest Operation Start Date\': \'2025-02-26\', \'R/3 start minus finish time\': 71, \'id\': 67, \'Material Type\': \'Others\'}]}], \'warning_info\': [], \'success\': True}, \'2\': {\'task_id\': \'2\', \'title\': \'查询changeover表\', \'instruction\': \'从changeover表中查询所有数据，以备后续使用。\', \'type\': \'functional\', \'input_parameters\': {\'export_table_name\': \'changeover_query_result\', \'sql\': \'SELECT * FROM changeover\', \'download_full\': True}, \'time_taken\': -1, \'token_taken\': -1, \'middle_results\': [], \'result\': [{\'category\': 0, \'category_translated\': \'text\', \'content\': [{\'Material Type\': \'Concentrate – P1\', \'Concentrate – P1\': 0, \'Concentrate – P2\': 1, \'Pungent\': 3, \'Sensitive\': 3, \'Others\': 3, \'id\': 0}, {\'Material Type\': \'Concentrate – P2\', \'Concentrate – P1\': 3, \'Concentrate – P2\': 0, \'Pungent\': 3, \'Sensitive\': 3, \'Others\': 3, \'id\': 1}, {\'Material Type\': \'Pungent\', \'Concentrate – P1\': 5, \'Concentrate – P2\': 5, \'Pungent\': 5, \'Sensitive\': 5, \'Others\': 5, \'id\': 2}, {\'Material Type\': \'Sensitive\', \'Concentrate – P1\': 5, \'Concentrate – P2\': 5, \'Pungent\': 5, \'Sensitive\': 5, \'Others\': 5, \'id\': 3}, {\'Material Type\': \'Others\', \'Concentrate – P1\': 5, \'Concentrate – P2\': 5, \'Pungent\': 3, \'Sensitive\': 3, \'Others\': 3, \'id\': 4}]}], \'warning_info\': [], \'success\': True}}\n    - User Query: The initial query from the user, which may provide specific details to support the current task.\n    [附加参数：:不需要]\n\n    # Step2:\n    1. follow the task instruction strictly and use info from the above context if needed. Earlier Result most likely contains info you need to use\n    2. put final answer in \'\'\'result    \'\'\'\n\n\n    # Expected output:do not output the thinking process!!!output the final result directly!!!\n    ```result\n\n            the_final_result\n\n    ```\n\n\n    '}]
    ans = asyncio.run(llm.aanswer(messages))